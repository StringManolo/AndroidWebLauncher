<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Web Launcher</title>
    <link rel="stylesheet" href="launcher.css">
    <style>
      .apps-container, .dock-container {
        contain: content; 
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-bg: rgba(15, 20, 30, 0.85);
        --secondary-bg: rgba(255, 255, 255, 0.12);
        --accent-color: #00d4ff;
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(255, 255, 255, 0.15);
        --success-color: #00ff88;
        --warning-color: #ffaa00;
        --danger-color: #ff4444;
        --danger-light: #ff8888;
      }

      body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #0f1a2b 0%, #1a2b3c 100%);
        min-height: 100vh;
        color: var(--text-primary);
        padding: 20px;
        padding-bottom: 140px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
      }

      .header {
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        border-radius: 24px;
        border: 1px solid var(--glass-border);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: transform 0.3s ease;
        will-change: transform;
      }

      .header:active {
        transform: scale(0.98);
      }

      .time-display {
        text-align: center;
      }

      .time {
        font-size: 3.5em;
        font-weight: 300;
        background: linear-gradient(135deg, var(--accent-color), #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
        font-variant-numeric: tabular-nums;
      }

      .date {
        font-size: 1.1em;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .search-container {
        position: relative;
        margin-bottom: 24px;
      }

      .search-input {
        width: 100%;
        padding: 18px 24px;
        padding-left: 52px;
        border: none;
        border-radius: 16px;
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        font-size: 16px;
        outline: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transition: border-color 0.3s ease, box-shadow 0.3s ease; 
      }

      .search-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
      }

      .search-input::placeholder {
        color: var(--text-secondary);
      }

      .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2em;
      }

      .apps-container {
        height: 58vh;
        overflow-y: auto;
        transform: translateZ(0); 
        -webkit-overflow-scrolling: touch;
        will-change: transform, scroll-position;
        scrollbar-width: none;
        padding: 4px;
      }

      .apps-container::-webkit-scrollbar {
        display: none;
      }

      .apps-container.no-scroll {
        overflow: hidden;
      }

      .apps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
        gap: 16px;
        padding: 8px;
      }

      .app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 12px;
        border-radius: 20px;
        background: var(--primary-bg);
        backdrop-filter: blur(30px); 
        border: 1px solid var(--glass-border);
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                    border-color 0.3s, 
                    box-shadow 0.3s;
        position: relative;
        user-select: none;
        transform: translateZ(0); 
        will-change: transform, box-shadow;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }

      .app-item:hover {
        transform: translateY(-4px);
        border-color: var(--accent-color);
        box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
      }

      .app-item.dragging {
        opacity: 0.8;
        transform: rotate(8deg) scale(1.05) translateZ(1px); 
        border-color: var(--accent-color);
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
        will-change: transform;
      }

      .app-item.hidden {
        display: none;
      }

      .app-icon {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        margin-bottom: 12px;
        object-fit: cover;
        background: linear-gradient(135deg, var(--secondary-bg), transparent);
        backface-visibility: hidden; 
        transform: translateZ(0);
      }

      .app-name {
        font-size: 12px;
        text-align: center;
        font-weight: 500;
        max-width: 76px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-primary);
      }

      .dock-container {
        position: fixed;
        bottom: 24px;
        left: 20px;
        right: 20px;
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        border-radius: 24px;
        border: 1px solid var(--glass-border);
        padding: 16px;
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
      }

      .dock-scroll {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 8px;
        scrollbar-width: none;
        -ms-overflow-style: none;
        transform: translateZ(0); 
        -webkit-overflow-scrolling: touch;
      }

      .dock-scroll::-webkit-scrollbar {
        display: none;
      }

      .dock-app {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease; 
        flex-shrink: 0;
        object-fit: cover;
        background: linear-gradient(135deg, var(--secondary-bg), transparent);
        will-change: transform;
      }

      .dock-app:hover {
        transform: scale(1.15);
        box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
      }

      /* ========== VISTA HORIZONTAL (DESKTOP HD) ========== */
      @media (orientation: landscape) and (min-height: 480px) {
        body {
          padding: 15px;
          padding-bottom: 100px;
        }

        .header {
          padding: 15px 20px;
          margin-bottom: 15px;
          border-radius: 16px;
        }

        .time {
          font-size: 2.2em;
          margin-bottom: 4px;
        }

        .date {
          font-size: 0.9em;
        }

        .search-container {
          margin-bottom: 15px;
        }

        .search-input {
          padding: 12px 20px;
          padding-left: 45px;
          font-size: 14px;
          border-radius: 12px;
        }

        .search-icon {
          left: 15px;
          font-size: 1em;
        }

        .apps-container {
          height: 65vh;
        }

        .apps-grid {
          grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
          gap: 12px;
          padding: 6px;
        }

        .app-item {
          padding: 12px 8px;
          border-radius: 14px;
        }

        .app-icon {
          width: 48px;
          height: 48px;
          border-radius: 12px;
          margin-bottom: 8px;
        }

        .app-name {
          font-size: 11px;
          max-width: 64px;
        }

        .dock-container {
          bottom: 15px;
          left: 15px;
          right: 15px;
          padding: 12px;
          border-radius: 16px;
        }

        .dock-scroll {
          gap: 12px;
        }

        .dock-app {
          width: 48px;
          height: 48px;
          border-radius: 12px;
        }

        .app-stats {
          margin-top: 12px;
          font-size: 11px;
        }
      }

      /* ========== VISTA HORIZONTAL EN PANTALLAS GRANDES ========== */
      @media (orientation: landscape) and (min-width: 1024px) {
        body {
          padding: 20px 10%;
          padding-bottom: 90px;
        }

        .header {
          padding: 12px 20px;
          margin-bottom: 12px;
        }

        .time {
          font-size: 2em;
        }

        .date {
          font-size: 0.85em;
        }

        .search-container {
          margin-bottom: 12px;
        }

        .apps-container {
          height: 70vh;
        }

        .apps-grid {
          grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
          gap: 10px;
        }

        .app-item {
          padding: 10px 6px;
          border-radius: 12px;
        }

        .app-icon {
          width: 44px;
          height: 44px;
          border-radius: 10px;
        }

        .app-name {
          font-size: 10px;
          max-width: 60px;
        }

        .dock-container {
          bottom: 12px;
          left: 10%;
          right: 10%;
          padding: 10px;
        }

        .dock-app {
          width: 44px;
          height: 44px;
        }
      }

      /* ========== VISTA HORIZONTAL EN PANTALLAS MUY GRANDES ========== */
      @media (orientation: landscape) and (min-width: 1366px) {
        body {
          padding: 15px 15%;
          padding-bottom: 80px;
        }

        .apps-grid {
          grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
          gap: 8px;
        }

        .app-icon {
          width: 40px;
          height: 40px;
        }

        .app-name {
          font-size: 9px;
          max-width: 55px;
        }

        .dock-container {
          left: 15%;
          right: 15%;
        }

        .dock-app {
          width: 40px;
          height: 40px;
        }
      }

      .drag-ghost {
        position: fixed !important;
        z-index: 10000 !important;
        pointer-events: none !important;
        transform: rotate(5deg) scale(1.1);
        box-shadow: 0 10px 40px rgba(0, 212, 255, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease; 
        will-change: transform, top, left; 
      }
      
      .drop-target {
        transform: scale(1.05);
        background: rgba(0, 212, 255, 0.2) !important;
        border-color: var(--accent-color) !important;
        transition: all 0.2s ease;
        will-change: transform;
      }

      /* Indicadores de Gestos */
      .gesture-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 20px 30px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        text-align: center;
        display: none;
        animation: gesture-popup 0.3s ease-out;
      }

      @keyframes gesture-popup {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .gesture-icon {
        font-size: 2em;
        margin-bottom: 8px;
      }

      .gesture-text {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* Modal Moderno */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: modal-fade-in 0.3s ease-out;
      }

      @keyframes modal-fade-in {
        from {
          opacity: 0;
          backdrop-filter: blur(0px);
        }
        to {
          opacity: 1;
          backdrop-filter: blur(20px);
        }
      }

      .modal-content {
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        padding: 30px;
        border-radius: 24px;
        border: 1px solid var(--glass-border);
        max-width: 90%;
        max-height: 80%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: modal-slide-up 0.3s ease-out;
      }

      @keyframes modal-slide-up {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-title {
        text-align: center;
        margin-bottom: 24px;
        font-size: 1.4em;
        font-weight: 600;
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .modal-btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        background: var(--secondary-bg);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .modal-btn.primary {
        background: linear-gradient(135deg, var(--accent-color), #0099ff);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
      }

      .modal-btn:active {
        transform: translateY(0);
      }

      /* Estados de Gestos */
      .app-item.press-1s {
        border-color: var(--warning-color);
        background: rgba(255, 170, 0, 0.1);
        animation: pulse-warning 1s infinite alternate;
      }

      .app-item.press-2s {
        border-color: var(--success-color);
        background: rgba(0, 255, 136, 0.1);
        animation: pulse-success 1s infinite alternate;
      }

      .app-item.press-4s {
        border-color: var(--danger-color);
        background: rgba(255, 68, 68, 0.1);
        animation: pulse-danger 0.8s infinite alternate;
      }

      .app-item.press-6s {
        border-color: var(--danger-color);
        background: rgba(255, 68, 68, 0.2);
        animation: pulse-danger-fast 0.5s infinite alternate;
      }

      @keyframes pulse-warning {
        from { 
          border-color: var(--warning-color);
          box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }
        to { 
          border-color: #ffcc00;
          box-shadow: 0 0 20px rgba(255, 170, 0, 0.6);
        }
      }

      @keyframes pulse-success {
        from { 
          border-color: var(--success-color);
          box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        to { 
          border-color: #00ffaa;
          box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }
      }

      @keyframes pulse-danger {
        from { 
          border-color: var(--danger-color);
          box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }
        to { 
          border-color: var(--danger-light);
          box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }
      }

      @keyframes pulse-danger-fast {
        from { 
          border-color: var(--danger-color);
          background: rgba(255, 68, 68, 0.2);
          box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }
        to { 
          border-color: var(--danger-light);
          background: rgba(255, 68, 68, 0.3);
          box-shadow: 0 0 25px rgba(255, 68, 68, 0.7);
        }
      }

      .app-stats {
        text-align: center;
        margin-top: 16px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .background-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, 
          rgba(15, 20, 30, 0.9) 0%, 
          rgba(26, 43, 60, 0.8) 100%);
        z-index: -1;
      }

      .uninstall-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(15px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: uninstall-modal-fade 0.3s ease;
      }

      @keyframes uninstall-modal-fade {
        from {
          opacity: 0;
          backdrop-filter: blur(0px);
        }
        to {
          opacity: 1;
          backdrop-filter: blur(15px);
        }
      }

      .uninstall-content {
        background: var(--primary-bg);
        backdrop-filter: blur(40px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 30px;
        max-width: 85%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        animation: uninstall-slide-up 0.3s ease;
      }

      @keyframes uninstall-slide-up {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .uninstall-icon {
        font-size: 3em;
        margin-bottom: 15px;
        color: var(--danger-color);
        animation: uninstall-pulse 2s infinite;
      }

      @keyframes uninstall-pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .uninstall-title {
        font-size: 1.3em;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .uninstall-message {
        margin-bottom: 25px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .uninstall-app-name {
        color: var(--text-primary);
        font-weight: 600;
      }

      .uninstall-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .uninstall-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 110px;
      }

      .uninstall-btn.confirm {
        background: linear-gradient(135deg, var(--danger-color), #ff2222);
        color: white;
      }

      .uninstall-btn.cancel {
        background: var(--secondary-bg);
        color: var(--text-primary);
      }

      .uninstall-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255, 68, 68, 0.4);
      }

      .uninstall-btn.cancel:hover {
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.2);
      }

      .uninstall-btn:active {
        transform: translateY(0);
      }

      .auto-scroll-top, .auto-scroll-bottom {
        position: fixed;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(180deg, 
          rgba(0, 212, 255, 0.3) 0%, 
          transparent 100%);
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .auto-scroll-top {
        top: 0;
        background: linear-gradient(0deg, 
          transparent 0%, 
          rgba(0, 212, 255, 0.3) 100%);
      }

      .auto-scroll-bottom {
        bottom: 0;
      }

      .auto-scroll-top.active, .auto-scroll-bottom.active {
        opacity: 1;
      }

      /* Mejoras de Responsividad para m√≥viles peque√±os */
      @media (max-width: 360px) {
        .apps-grid {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          gap: 12px;
        }

        .app-item {
          padding: 16px 10px;
        }

        .app-icon {
          width: 50px;
          height: 50px;
        }

        .time {
          font-size: 3em;
        }
      }

      /* ========== AJUSTES ESPEC√çFICOS PARA HORIZONTAL EN M√ìVILES PEQUE√ëOS ========== */
      @media (orientation: landscape) and (max-height: 480px) {
        body {
          padding: 10px;
          padding-bottom: 70px;
        }

        .header {
          padding: 10px 15px;
          margin-bottom: 10px;
        }

        .time {
          font-size: 1.8em;
        }

        .date {
          font-size: 0.8em;
        }

        .apps-container {
          height: 60vh;
        }

        .apps-grid {
          grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
          gap: 8px;
        }

        .app-item {
          padding: 8px 4px;
        }

        .app-icon {
          width: 40px;
          height: 40px;
        }

        .app-name {
          font-size: 9px;
          max-width: 55px;
        }

        .dock-container {
          bottom: 10px;
          padding: 8px;
        }

        .dock-app {
          width: 40px;
          height: 40px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      .app-item:focus-visible,
      .dock-app:focus-visible,
      .modal-btn:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
      }

      .performance-optimized {
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000;
      }
    </style>
  </head>
  <body>
    <div class="background-overlay"></div>

    <div class="auto-scroll-top" id="autoScrollTop"></div>
    <div class="auto-scroll-bottom" id="autoScrollBottom"></div>

    <div class="header" id="headerArea">
      <div class="time-display">
        <div class="time" id="currentTime">--:--</div>
        <div class="date" id="currentDate">--- --, ----</div>
      </div>
    </div>

    <div class="search-container">
      <div class="search-icon">üîç</div>
      <input type="text" class="search-input" id="searchInput" 
                                              placeholder="Buscar aplicaciones..." 
                                              autocomplete="off" 
                                              spellcheck="false"> 
    </div>

    <div class="apps-container" id="appsContainer">
      <div class="apps-grid" id="appsGrid">
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
        <div class="app-item loading-skeleton">
          <div class="app-icon" style="background: rgba(255,255,255,0.1);"></div>
          <div class="app-name">Cargando...</div>
        </div>
      </div>
    </div>

    <div class="dock-container">
      <div class="dock-scroll" id="dockScroll">
        <div style="color: var(--text-secondary); padding: 16px; text-align: center; font-size: 14px;">
          Mant√©n 2s en cualquier app para agregar al dock
        </div>
      </div>
      <div class="app-stats" id="appStats">
        Cargando aplicaciones...
      </div>
    </div>

    <div class="modal" id="wallpaperModal">
      <div class="modal-content">
        <div class="modal-title">Personalizar Fondo</div>
        <div class="modal-buttons">
          <button class="modal-btn primary" id="galleryBtn">Galer√≠a</button>
          <button class="modal-btn" id="defaultWallpaperBtn">Predeterminado</button>
          <button class="modal-btn" id="cancelModalBtn">Cancelar</button>
        </div>
      </div>
    </div>

    <div class="gesture-indicator" id="gestureIndicator">
      <div class="gesture-icon" id="gestureIcon">üëÜ</div>
      <div class="gesture-text" id="gestureText">Mant√©n presionado</div>
    </div>

    <input type="file" id="wallpaperInput" accept="image/*" style="display: none;">

    <script>
      let allApps = [];
      let favoriteApps = JSON.parse(localStorage.getItem('favoriteApps')) || [];
      let hiddenApps = JSON.parse(localStorage.getItem('hiddenApps')) || [];
      let appPositions = JSON.parse(localStorage.getItem('appPositions')) || {};

      const appsContainer = document.getElementById('appsContainer');
      const appsGrid = document.getElementById('appsGrid');
      const dockScroll = document.getElementById('dockScroll');
      const searchInput = document.getElementById('searchInput');
      const appStatsElement = document.getElementById('appStats');
      const currentTimeElement = document.getElementById('currentTime');
      const currentDateElement = document.getElementById('currentDate');
      const headerArea = document.getElementById('headerArea');
      const wallpaperModal = document.getElementById('wallpaperModal');
      const gestureIndicator = document.getElementById('gestureIndicator');
      const gestureText = document.getElementById('gestureText');
      const gestureIcon = document.getElementById('gestureIcon');

      let currentGesture = {
        appElement: null,
        packageName: null,
        startTime: 0,
        startX: 0,
        startY: 0,
        timer: null,
        isDragging: false,
        hasMoved: false,
        dragElement: null,
        dropTarget: null
      };

      let dragScrollInterval = null;
      let isReordering = false;

      const GESTURE_TIMING = {
        TAP: 500,
        DRAG_START: 1000,
        FAVORITE: 2000,
        HIDE: 4000,
        UNINSTALL: 6000
      };

      const MOVE_THRESHOLD = 20;

      window.loadAllApps = function(apps) {
        requestAnimationFrame(() => {
          allApps = apps;
          renderApps();
          updateTime();
          updateAppStats();
        });
        
        if (!window.timeUpdateInterval) {
           window.timeUpdateInterval = setInterval(updateTime, 1000);
        }
      };

      document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        updateTime();
        updateAppStats();
        loadSavedWallpaper();

        document.addEventListener('touchmove', function(e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        }, { passive: false });

        document.addEventListener('touchstart', function(e) {
          if (e.target.closest('.apps-container') || e.target.closest('.dock-scroll')) {
          }
        }, { passive: true });
      });

      function initializeEventListeners() {
        searchInput.addEventListener('input', filterApps);

        document.getElementById('galleryBtn').addEventListener('click', selectWallpaperFromGallery);
        document.getElementById('defaultWallpaperBtn').addEventListener('click', useDefaultWallpaper);
        document.getElementById('cancelModalBtn').addEventListener('click', closeModal);

        document.getElementById('wallpaperInput').addEventListener('change', handleWallpaperSelect);

        setupHeaderGestureEvents(headerArea);

        setupDoubleTapForWallpaper(headerArea);

        document.addEventListener('touchmove', function(e) {
          if (currentGesture.isDragging || isReordering) {
            e.preventDefault();
          }
        }, { passive: false });
      }

      function setupHeaderGestureEvents(headerElement) {
        let headerPressTimer = null;

        const startPress = () => {
           headerPressTimer = setTimeout(() => {
            showHiddenApps();
          }, GESTURE_TIMING.HIDE);
        };
        
        const endPress = () => {
           if (headerPressTimer) {
            clearTimeout(headerPressTimer);
            headerPressTimer = null;
          }
        };

        headerElement.addEventListener('touchstart', startPress);
        headerElement.addEventListener('touchend', endPress);
        headerElement.addEventListener('touchmove', endPress); 
        headerElement.addEventListener('mousedown', startPress);
        headerElement.addEventListener('mouseup', endPress);
        headerElement.addEventListener('mouseleave', endPress);
      }

      function setupDoubleTapForWallpaper(headerElement) {
        let lastTap = 0;
        headerElement.addEventListener('touchend', function(e) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;
          if (tapLength < 300 && tapLength > 0) {
            openWallpaperPicker();
          }
          lastTap = currentTime;
        });
      }

      function renderApps() {
        const fragment = document.createDocumentFragment();
        
        const sortedApps = [...allApps].sort((a, b) => {
          const aPos = appPositions[a.packageName] === undefined ? allApps.findIndex(app => app.packageName === a.packageName) : appPositions[a.packageName];
          const bPos = appPositions[b.packageName] === undefined ? allApps.findIndex(app => app.packageName === b.packageName) : appPositions[b.packageName];
          return aPos - bPos;
        });

        sortedApps.forEach((app, index) => {
            appPositions[app.packageName] = index;
        });

        sortedApps.forEach(app => {
          if (hiddenApps.includes(app.packageName)) {
            return;
          }

          const appElement = createAppElement(app);
          fragment.appendChild(appElement);
        });

        appsGrid.innerHTML = '';
        appsGrid.appendChild(fragment);

        renderDock();
        saveAppPositions();
      }

      function createAppElement(app) {
        const appElement = document.createElement('div');
        appElement.className = 'app-item performance-optimized';
        appElement.setAttribute('data-package', app.packageName);

        appElement.innerHTML = `
        <img src="data:image/png;base64,${app.icon}" 
             class="app-icon performance-optimized" alt="${app.name}"
             loading="lazy"
             onerror="this.style.background='rgba(255,255,255,0.1)'">
        <div class="app-name">${app.name}</div>
    `;

        setupGestureEvents(appElement, app);

        return appElement;
      }

      function setupGestureEvents(appElement, app) {
        const passiveFalseOptions = { passive: false };
        const passiveTrueOptions = { passive: true };

        appElement.addEventListener('touchstart', handleGestureStart.bind(null, appElement, app), passiveFalseOptions);
        appElement.addEventListener('touchmove', handleGestureMove, passiveFalseOptions); 
        appElement.addEventListener('touchend', handleGestureEnd, passiveTrueOptions);

        appElement.addEventListener('mousedown', handleGestureStart.bind(null, appElement, app), passiveFalseOptions);
        appElement.addEventListener('mousemove', handleGestureMove, passiveFalseOptions);
        appElement.addEventListener('mouseup', handleGestureEnd, passiveTrueOptions);
        appElement.addEventListener('mouseleave', handleGestureCancel, passiveTrueOptions);
      }

      function handleGestureStart(appElement, app, event) {
        const isTouch = event.type.includes('touch');
        const eventData = isTouch ? event.touches[0] : event;
        const clientX = eventData.clientX;
        const clientY = eventData.clientY;

        currentGesture = {
          appElement: appElement,
          packageName: app.packageName,
          startTime: performance.now(),
          startX: clientX,
          startY: clientY,
          timer: null,
          isDragging: false,
          hasMoved: false,
          dragElement: null,
          dropTarget: null
        };

        currentGesture.timer = setTimeout(() => {
          if (!currentGesture.hasMoved) {
            showGestureFeedback('Mover para reordenar', '‚ÜïÔ∏è');
            appElement.classList.add('press-1s');
          }
        }, GESTURE_TIMING.DRAG_START);

        setTimeout(() => {
          if (currentGesture.appElement === appElement && !currentGesture.hasMoved && !currentGesture.isDragging) {
            showGestureFeedback('Agregar a favoritos', '‚≠ê');
            appElement.classList.remove('press-1s');
            appElement.classList.add('press-2s');
          }
        }, GESTURE_TIMING.FAVORITE);

        setTimeout(() => {
          if (currentGesture.appElement === appElement && !currentGesture.hasMoved && !currentGesture.isDragging) {
            showGestureFeedback('Ocultar aplicaci√≥n', 'üëÅÔ∏è');
            appElement.classList.remove('press-2s');
            appElement.classList.add('press-4s');
          }
        }, GESTURE_TIMING.HIDE);

        setTimeout(() => {
          if (currentGesture.appElement === appElement && !currentGesture.hasMoved && !currentGesture.isDragging) {
            showGestureFeedback('Desinstalar aplicaci√≥n', 'üóëÔ∏è');
            appElement.classList.remove('press-4s');
            appElement.classList.add('press-6s');
          }
        }, GESTURE_TIMING.UNINSTALL);

        if (!isTouch) {
          event.preventDefault();
        }
      }

      function handleGestureMove(event) {
        if (!currentGesture.appElement) return;

        const isTouch = event.type.includes('touch');
        const eventData = isTouch ? event.touches[0] : event;
        const clientX = eventData.clientX;
        const clientY = eventData.clientY;

        const deltaX = Math.abs(clientX - currentGesture.startX);
        const deltaY = Math.abs(clientY - currentGesture.startY);
        const totalMove = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

        if (totalMove > MOVE_THRESHOLD) {
          currentGesture.hasMoved = true;

          const elapsedTime = performance.now() - currentGesture.startTime;
          if (elapsedTime >= GESTURE_TIMING.DRAG_START && !currentGesture.isDragging) {
            startDrag(currentGesture.appElement, clientX, clientY);
          }

          if (currentGesture.isDragging) {
            requestAnimationFrame(() => {
              updateDragPosition(clientX, clientY);
              checkAutoScroll(clientY);
            });
          }
        }

        if ((currentGesture.isDragging || currentGesture.hasMoved) && event.cancelable) {
            event.preventDefault();
        }
      }

      function handleGestureEnd(event) {
        if (!currentGesture.appElement) return;

        const elapsedTime = performance.now() - currentGesture.startTime;
        
        clearTimeout(currentGesture.timer);
        currentGesture.appElement.classList.remove('press-1s', 'press-2s', 'press-4s', 'press-6s');
        hideGestureFeedback();
        stopAutoScroll();

        if (!currentGesture.hasMoved && !currentGesture.isDragging) {
          if (elapsedTime < GESTURE_TIMING.TAP) {
            launchApp(currentGesture.packageName);
          } else if (elapsedTime >= GESTURE_TIMING.FAVORITE && elapsedTime < GESTURE_TIMING.HIDE) {
            toggleFavorite(currentGesture.packageName);
          } else if (elapsedTime >= GESTURE_TIMING.HIDE && elapsedTime < GESTURE_TIMING.UNINSTALL) {
            toggleAppVisibility(currentGesture.packageName);
          } else if (elapsedTime >= GESTURE_TIMING.UNINSTALL) {
            showUninstallConfirmation(currentGesture.packageName, currentGesture.appElement.querySelector('.app-name').textContent);
          }
        }

        if (currentGesture.isDragging) {
          endDrag();
        }

        currentGesture = {
          appElement: null,
          packageName: null,
          startTime: 0,
          startX: 0,
          startY: 0,
          timer: null,
          isDragging: false,
          hasMoved: false,
          dragElement: null,
          dropTarget: null
        };
      }

      function handleGestureCancel() {
        if (currentGesture.appElement) {
          clearTimeout(currentGesture.timer);
          currentGesture.appElement.classList.remove('press-1s', 'press-2s', 'press-4s', 'press-6s');
          hideGestureFeedback();
          stopAutoScroll();

          if (currentGesture.isDragging) {
            endDrag();
          }

          currentGesture = {
            appElement: null,
            packageName: null,
            startTime: 0,
            startX: 0,
            startY: 0,
            timer: null,
            isDragging: false,
            hasMoved: false,
            dragElement: null,
            dropTarget: null
          };
        }
      }

      function startDrag(appElement, clientX, clientY) {
        currentGesture.isDragging = true;
        isReordering = true;

        const dragElement = appElement.cloneNode(true);
        dragElement.style.position = 'fixed';
        dragElement.style.zIndex = '10000';
        dragElement.style.pointerEvents = 'none';
        dragElement.style.transform = 'rotate(5deg) scale(1.1)';
        dragElement.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.5)';
        dragElement.classList.add('dragging');
        dragElement.classList.add('drag-ghost');

        document.body.appendChild(dragElement);
        currentGesture.dragElement = dragElement;

        const rect = appElement.getBoundingClientRect();
        
        currentGesture.dragElement.style.left = rect.left + 'px';
        currentGesture.dragElement.style.top = rect.top + 'px';
        
        appElement.style.opacity = '0.3';

        updateDragPosition(clientX, clientY, true);

        hideGestureFeedback();
      }

      function updateDragPosition(clientX, clientY, isInit = false) {
        if (!currentGesture.dragElement) return;

        const dragElement = currentGesture.dragElement;
        
        const deltaX = clientX - currentGesture.startX;
        const deltaY = clientY - currentGesture.startY;

        if (isInit) {
            dragElement.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(5deg) scale(1.1)`;
        } else {
             dragElement.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(5deg) scale(1.1)`;
        }

        checkReordering(clientX, clientY);
      }

      function checkReordering(clientX, clientY) {
        const appElements = appsGrid.querySelectorAll('.app-item');
        let closestElement = null;
        let closestDistance = Infinity;

        const rectMap = new Map();
        appElements.forEach(element => {
            rectMap.set(element, element.getBoundingClientRect());
        });

        appElements.forEach(element => {
          if (element.style.opacity !== '0.3' && !hiddenApps.includes(element.getAttribute('data-package'))) { 
            const rect = rectMap.get(element);
            const elementCenterX = rect.left + rect.width / 2;
            const elementCenterY = rect.top + rect.height / 2;

            const distance = Math.sqrt(
              Math.pow(clientX - elementCenterX, 2) + 
              Math.pow(clientY - elementCenterY, 2)
            );

            if (distance < closestDistance) {
              closestDistance = distance;
              closestElement = element;
            }
          }
        });

        requestAnimationFrame(() => {
            appElements.forEach(element => {
              element.classList.remove('drop-target');
            });

            if (closestElement && closestDistance < 100) {
              closestElement.classList.add('drop-target');
              currentGesture.dropTarget = closestElement;
            } else {
              currentGesture.dropTarget = null;
            }
        });
      }

      function endDrag() {
        if (currentGesture.dragElement) {
          requestAnimationFrame(() => {
            currentGesture.dragElement.remove();
            currentGesture.dragElement = null;
          });
        }

        if (currentGesture.appElement) {
          currentGesture.appElement.style.opacity = '';
        }

        if (currentGesture.dropTarget) {
          const targetPackage = currentGesture.dropTarget.getAttribute('data-package');
          const sourcePackage = currentGesture.packageName;

          reorderApps(sourcePackage, targetPackage);

          currentGesture.dropTarget.classList.remove('drop-target');
        }

        appsGrid.querySelectorAll('.app-item').forEach(element => {
          element.classList.remove('drop-target');
        });

        currentGesture.isDragging = false;
        isReordering = false;
        currentGesture.dropTarget = null;
      }

      function reorderApps(sourcePackage, targetPackage) {
        let sourceIndex = -1;
        let targetIndex = -1;
        
        const allPackages = allApps.map(app => app.packageName);
        sourceIndex = allApps.findIndex(app => app.packageName === sourcePackage);
        targetIndex = allApps.findIndex(app => app.packageName === targetPackage);

        if (sourceIndex !== -1 && targetIndex !== -1 && sourceIndex !== targetIndex) {
          const [movedApp] = allApps.splice(sourceIndex, 1);
          allApps.splice(targetIndex, 0, movedApp);

          allApps.forEach((app, index) => {
            appPositions[app.packageName] = index;
          });

          saveAppPositions();
          renderApps();

          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("üì± Apps reordenadas");
          }
        }
      }

      function checkAutoScroll(clientY) {
        const containerRect = appsContainer.getBoundingClientRect();
        const scrollThreshold = 100;

        stopAutoScroll();

        if (clientY < containerRect.top + scrollThreshold) {
          startAutoScroll(-1);
          document.getElementById('autoScrollTop').classList.add('active');
        } else {
          document.getElementById('autoScrollTop').classList.remove('active');
        }

        if (clientY > containerRect.bottom - scrollThreshold) {
          startAutoScroll(1);
          document.getElementById('autoScrollBottom').classList.add('active');
        } else {
          document.getElementById('autoScrollBottom').classList.remove('active');
        }
      }

      function startAutoScroll(direction) {
        const scrollSpeed = 20;

        let lastScrollTime = performance.now();
        const scrollStep = (timestamp) => {
          const deltaTime = timestamp - lastScrollTime;
          lastScrollTime = timestamp;
          appsContainer.scrollTop += scrollSpeed * direction * (deltaTime / 16); 

          if (dragScrollInterval) {
            dragScrollInterval = requestAnimationFrame(scrollStep);
          }
        };

        if (dragScrollInterval) stopAutoScroll();
        dragScrollInterval = requestAnimationFrame(scrollStep);
      }

      function stopAutoScroll() {
        if (dragScrollInterval) {
          cancelAnimationFrame(dragScrollInterval);
          dragScrollInterval = null;
        }
        document.getElementById('autoScrollTop').classList.remove('active');
        document.getElementById('autoScrollBottom').classList.remove('active');
      }

      function showUninstallConfirmation(packageName, appName) {
        const modal = document.createElement('div');
        modal.className = 'uninstall-modal';
        modal.innerHTML = `
        <div class="uninstall-content">
            <div class="uninstall-icon">‚ö†Ô∏è</div>
            <div class="uninstall-title">Desinstalar aplicaci√≥n</div>
            <div class="uninstall-message">
                ¬øEst√°s seguro de que quieres desinstalar "<span class="uninstall-app-name">${appName}</span>"?
            </div>
            <div class="uninstall-buttons">
                <button class="uninstall-btn confirm">Desinstalar</button>
                <button class="uninstall-btn cancel">Cancelar</button>
            </div>
        </div>
    `;

        document.body.appendChild(modal);

        modal.querySelector('.uninstall-btn.confirm').addEventListener('click', function() {
          if (typeof Android !== 'undefined' && Android.uninstallApp) {
            Android.uninstallApp(packageName);
          }
          modal.remove();
        });

        modal.querySelector('.uninstall-btn.cancel').addEventListener('click', function() {
          modal.remove();
        });

        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function openWallpaperPicker() {
        wallpaperModal.style.display = 'flex';
      }

      function closeModal() {
        wallpaperModal.style.display = 'none';
      }

      function selectWallpaperFromGallery() {
        if (typeof Android !== 'undefined' && Android.openGallery) {
          Android.openGallery();
        } else {
          document.getElementById('wallpaperInput').click();
        }
        closeModal();
      }

      function useDefaultWallpaper() {
        if (localStorage.getItem('customWallpaper')) {
           document.body.style.backgroundImage = '';
           document.body.style.background = 'linear-gradient(135deg, #0f1a2b 0%, #1a2b3c 100%)';
           localStorage.removeItem('customWallpaper');
           if (typeof Android !== 'undefined' && Android.showToast) {
             Android.showToast("üé® Fondo restaurado");
           }
        }
        closeModal();
      }

      function handleWallpaperSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleImageFile(file);
        }
      }
      
      function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚ùå Solo se permiten im√°genes");
          }
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚ùå Imagen demasiado grande (m√°x. 10MB)");
          }
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          applyWallpaper(e.target.result);
        };
        reader.onerror = function() {
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚ùå Error al cargar la imagen");
          }
        };
        reader.readAsDataURL(file);
      }

      function applyWallpaper(imageData) {
        document.body.style.backgroundImage = `url(${imageData})`;
        localStorage.setItem('customWallpaper', imageData);
        if (typeof Android !== 'undefined' && Android.showToast) {
          Android.showToast("üé® Fondo actualizado");
        }
      }

      window.onImageSelected = function(imageUri) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const base64Data = canvas.toDataURL('image/jpeg', 0.8);
          applyWallpaper(base64Data);
        };
        img.onerror = function() {
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚ùå Error al cargar la imagen");
          }
          console.error("Error loading image from URI:", imageUri);
        };
        img.src = imageUri;
      };

      function loadSavedWallpaper() {
        const savedWallpaper = localStorage.getItem('customWallpaper');
        if (savedWallpaper) {
          const img = new Image();
          img.onload = function() {
            document.body.style.backgroundImage = `url(${savedWallpaper})`;
          };
          img.onerror = function() {
            localStorage.removeItem('customWallpaper');
            document.body.style.background = 'linear-gradient(135deg, #0f1a2b 0%, #1a2b3c 100%)';
          };
          img.src = savedWallpaper;
        }
      }

      function showGestureFeedback(text, icon) {
          gestureText.textContent = text;
          gestureIcon.textContent = icon;
          gestureIndicator.style.display = 'block';
        }

      function hideGestureFeedback() {
        gestureIndicator.style.display = 'none';
      }

      function showHiddenApps() {
        if (hiddenApps.length > 0) {
          hiddenApps = [];
          localStorage.removeItem('hiddenApps');
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("üëÅÔ∏è Apps ocultas mostradas");
          }
        } else {
          hiddenApps = JSON.parse(localStorage.getItem('hiddenApps')) || [];
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("üëÅÔ∏è‚Äçüó®Ô∏è Apps ocultas restauradas");
          }
        }
        renderApps();
        updateAppStats();
      }

      function renderDock() {
        const fragment = document.createDocumentFragment();

        favoriteApps.forEach(packageName => {
          const app = allApps.find(a => a.packageName === packageName);
          if (app) {
            const dockApp = document.createElement('img');
            dockApp.className = 'dock-app performance-optimized';
            dockApp.src = `data:image/png;base64,${app.icon}`;
            dockApp.alt = app.name;
            dockApp.title = app.name;
            dockApp.onclick = () => launchApp(app.packageName);
            fragment.appendChild(dockApp);
          }
        });

        dockScroll.innerHTML = '';
        if (favoriteApps.length === 0) {
          dockScroll.innerHTML = '<div style="color: var(--text-secondary); padding: 16px; text-align: center; font-size: 14px;">Mant√©n 2s en cualquier app para agregar al dock</div>';
        } else {
           dockScroll.appendChild(fragment);
        }
      }

      function launchApp(packageName) {
        if (typeof Android !== 'undefined' && Android.launchApp) {
          Android.launchApp(packageName);
        }
      }

      function toggleFavorite(packageName) {
        const index = favoriteApps.indexOf(packageName);
        if (index > -1) {
          favoriteApps.splice(index, 1);
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚ùå Removido de favoritos");
          }
        } else {
          favoriteApps.push(packageName);
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("‚≠ê Agregado a favoritos");
          }
        }
        localStorage.setItem('favoriteApps', JSON.stringify(favoriteApps));
        renderDock(); 
        updateAppStats();
      }

      function toggleAppVisibility(packageName) {
        const index = hiddenApps.indexOf(packageName);
        if (index > -1) {
          hiddenApps.splice(index, 1);
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("üëÅÔ∏è App mostrada");
          }
        } else {
          hiddenApps.push(packageName);
          if (typeof Android !== 'undefined' && Android.showToast) {
            Android.showToast("üëÅÔ∏è‚Äçüó®Ô∏è App ocultada");
          }
        }
        localStorage.setItem('hiddenApps', JSON.stringify(hiddenApps));
        renderApps();
        updateAppStats();
      }

      function filterApps() {
        const searchTerm = searchInput.value.toLowerCase();
        const appItems = appsGrid.querySelectorAll('.app-item');

        let visibleCount = 0;
        appItems.forEach(item => {
          const appName = item.querySelector('.app-name').textContent.toLowerCase();
          const packageName = item.getAttribute('data-package');

          const isHidden = hiddenApps.includes(packageName);
          const isMatch = appName.includes(searchTerm);

          if (isMatch && !isHidden) {
            item.classList.remove('hidden');
            visibleCount++;
          } else {
            item.classList.add('hidden');
          }
        });

        updateAppStats(visibleCount);
      }

      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        const dateString = now.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        const newDateText = dateString.charAt(0).toUpperCase() + dateString.slice(1);

        if (currentTimeElement.textContent !== timeString) {
           currentTimeElement.textContent = timeString;
        }
        if (currentDateElement.textContent !== newDateText) {
           currentDateElement.textContent = newDateText;
        }
      }

      function updateAppStats(visibleCount = null) {
        const totalVisible = visibleCount !== null ? visibleCount : allApps.filter(app => !hiddenApps.includes(app.packageName)).length;

        const newStats = `${totalVisible} apps ‚Ä¢ ${favoriteApps.length} favoritos ‚Ä¢ ${hiddenApps.length} ocultas`;

        if (appStatsElement.textContent.trim() !== newStats.trim()) {
           appStatsElement.textContent = newStats;
        }
      }

      function saveAppPositions() {
        localStorage.setItem('appPositions', JSON.stringify(appPositions));
      }

      document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('app-item') || e.target.classList.contains('dock-app')) {
          e.preventDefault();
        }
      });

      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }

      window.addEventListener('orientationchange', function() {
        setTimeout(() => {
          renderApps();
        }, 300);
      });

      window.addEventListener('resize', function() {
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(() => {
          renderApps();
        }, 250);
      });

      window.debugLauncher = {
        getAllApps: () => allApps,
        getFavoriteApps: () => favoriteApps,
        getHiddenApps: () => hiddenApps,
        getAppPositions: () => appPositions,
        clearData: () => {
          localStorage.clear();
          favoriteApps = [];
          hiddenApps = [];
          appPositions = {};
          renderApps();
        },
        simulateGesture: (packageName, gestureType) => {
          const appElement = document.querySelector(`[data-package="${packageName}"]`);
          if (appElement) {
            switch(gestureType) {
              case 'favorite':
                toggleFavorite(packageName);
                break;
              case 'hide':
                toggleAppVisibility(packageName);
                break;
              case 'uninstall':
                const appName = appElement.querySelector('.app-name').textContent;
                showUninstallConfirmation(packageName, appName);
                break;
            }
          }
        }
      }
    </script>
  </body>
</html>